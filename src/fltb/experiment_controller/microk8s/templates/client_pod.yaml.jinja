apiVersion: v1
kind: Pod
metadata:
  name: {{ pod_name }}
  fltb-job-id: {{ job_id }}
spec:
  initContainers:
  - name: wait-for-fl-server
    image: busybox:1.28
    command: ['sh', '-c', "until nslookup fl-server-svc.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for fl-server-svc; sleep 2; done"]
  containers:
  - name: fl-client
    image: {{ image }}
    command: ["python3", "{{ client_entrypoint }}"]
    args: {{ image_args }}
    env:
      - name: FLTB_ENV
        value: "1"
      - name: FLTB_SERVER_ADDRESS
        value: "fl-server-svc:80"
      - name: FLTB_JOB_ID
        value: "{{ job_id }}"
      - name: FLTB_CLIENT_ID
        value: "{{ client_id }}"
      - name: FLTB_CLIENT_DB_ID
        value: "{{ client_db_id }}"

      - name: FLTB_DATA_HOME_FOLDER
        value: "/fltb/datasets"
      - name: FLTB_PYTORCH_DATASETS
        value: "/fltb/pytorch_datasets"        
    volumeMounts:
    - mountPath: /fltb/datasets
      name: fltb-std-datasets
    - mountPath: /fltb/pytorch_datasets
      name: fltb-pytorch-datasets
{% if jetson_dev is defined %}
    - mountPath: /run/jtop.sock
      name: jtop-socket
{% endif %}
  volumes:
  - name: fltb-std-datasets
    hostPath:
      path: {{ std_datasets_path }}
      type: Directory
  - name: fltb-pytorch-datasets
    hostPath:
      path: {{ pytorch_datasets_path }}
      type: Directory
{% if jetson_dev is defined %}
  - name: jtop-socket
    hostPath:
      path: /run/jtop.sock
      type: Socket
{% endif %}
  restartPolicy: Never
  imagePullSecrets:
    - name: regcred
  nodeSelector:
    kubernetes.io/hostname: {{ device_hostname }}