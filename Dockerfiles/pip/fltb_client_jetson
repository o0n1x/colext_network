FROM nvcr.io/nvidia/l4t-pytorch:r35.2.1-pth2.0-py3
# Comes with Python 3.8.10

ARG USER_CODE_PATH
RUN test -n "$USER_CODE_PATH"
ARG FLTB_PATH
RUN test -n "$FLTB_PATH"

# Required to install flwr
RUN python3 -m pip install --no-cache-dir --upgrade pip setuptools
RUN python3 -m pip install --no-cache-dir psutil psycopg[binary] jetson-stats

WORKDIR /fl_testbed
# Add fltb src to pythonpath
ENV PYTHONPATH "/fl_testbed:${PYTHONPATH}"

COPY ${USER_CODE_PATH}/requirements.txt ./user_code/
RUN python3 -m pip install --no-cache-dir -r ./user_code/requirements.txt

COPY $USER_CODE_PATH ./user_code
COPY $FLTB_PATH ./fltb

WORKDIR /fl_testbed/user_code

ENV PYTHONPATH "/fl_testbed:/fl_testbed/user_code:${PYTHONPATH}"