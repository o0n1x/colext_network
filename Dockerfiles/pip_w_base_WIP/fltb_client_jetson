FROM nvcr.io/nvidia/l4t-pytorch:r35.2.1-pth2.0-py3
# Comes with Python 3.8.10

ARG USER_CODE_RELATIVE_PATH
RUN test -n "$USER_CODE_RELATIVE_PATH"

# Required to install flwr
RUN python3 -m pip install --no-cache-dir --upgrade pip setuptools
RUN python3 -m pip install --no-cache-dir flwr tqdm psutil psycopg[binary] jetson-stats

WORKDIR /fl_testbed
# Add fltb src to pythonpath
ENV PYTHONPATH "`pwd`/fltb:"

COPY ./src/fltb ./fltb
COPY $USER_CODE_RELATIVE_PATH ./user_code
RUN python3 -m pip install -r ./user_code/requirements.txt

ENTRYPOINT ["python3"]